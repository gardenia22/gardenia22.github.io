<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="阿里, 比赛, 机器学习, 数据挖掘, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="机器学习第一战——阿里天池移动推荐算法比赛经验总结攻略 : nanshu.wang"/>
<meta property="og:site_name" content="nanshu wang blog"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://nanshu.wang/post/2015-07-01">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2015-07-01"/>
<meta property="article:modified_time" content="2015-07-01"/>



<meta property="article:tag" content="阿里">
<meta property="article:tag" content="比赛">
<meta property="article:tag" content="机器学习">
<meta property="article:tag" content="数据挖掘">





    <base href="http://nanshu.wang">
    <title> 机器学习第一战——阿里天池移动推荐算法比赛经验总结攻略 - nanshu.wang </title>
    <link rel="canonical" href="http://nanshu.wang/post/2015-07-01">
    

    <link href='http://fonts.useso.com/css?family=Fjalla+One|Open+Sans:300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/static/css/style.css">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?a79535ca63291dc820e3ecefa615aad1";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>

</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
	<nav id="nav">
	<div id="title"><a href="/">Nanshu Wang</a></div>
    <div><a href=mailto: nanshu.wang@gmail.com target="_blank" class="mailto"> </span> <span class="icon-mail"></span>gardenia22</a></div>
	</nav>
    <nav id="nav">
    	        <ul id="mainnav">
            <li>
                <a href="/蘅芜/">
                <span class="icon"> <i aria-hidden="true" class="icon-pencil"></i></span>
                <span> 蘅芜 </span>
            </a>
            </li>
            <li>
            <a href="/潇湘/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> 潇湘 </span>
            </a>
            </li>
            <li>
            <a href="/观叹/">
                <span class="icon"> <i aria-hidden="true" class="icon-leaf"></i></span>
                <span> 观叹 </span>
            </a>
            </li>
            <li>
            <a href="/about">
                <span class="icon"> <i aria-hidden="true" class="icon-heart"></i></span>
                <span> 关于 </span>
            </a>
            </li>
        </ul>

    </nav>
    <nav id="nav">
       	        <ul id="social">
            
            <li id="share">
                <span class="title"> 友链 </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="http://xgezhang.com" target="_blank" title="xge技术博客" class="twitter">xge</a> </li>
                      <li> <a href="http://spf13.com" target="_blank" title="spf13 is Steve Francis" class="facebook">spf13</a> </li>
                      <li> <a href="http://libaier.net" target="_blank" title="Libaier" class="rss">Libaier</a> </li>
                      <li> <a href="http://read.douban.com/column/195295/" target="_blank" title="100个故事" class="douban">一百个故事</a></li>
                      <li> <a href="http://zhangwenli.com/blog/" target="_blank" title="羡辙杂俎" class="yangzhe">羡辙杂俎</a></li>
                    </ul>
                <span class="icon icon-bubbles"> </span> <span class="subcount"></span> </div>
            </li>
    
            <li id="follow">
                <span class="title"> 驻留地 </span>
                <div class="dropdown follow">
                    <ul class="social">
                        

                        <li> <a href="http://weibo.com/gardenia22/" target="_blank" title="微博" class="weibo">微博</a> </li>
                        <li> <a href="http://www.douban.com/people/gardenia22" target="_blank"
                        title="豆瓣" class="douban">豆瓣</a> </li>
                        <li> <a href="http://www.zhihu.com/people/gardenia" target="_blank" title="知乎" class="zhihu">知乎</a> </li>
                        <li> <a href="http://github.com/gardenia22" target="_blank" title="GitHub" class="github">GitHub</a> </li>                         
                        <li> <a href="http://www.facebook.com/gardenia.nanshu.wang" target="_blank" title="Facebook" class="facebook"> Facebook</a></li>
                        <li> <a href="http://instagram.com/ainedrag22" target="_blank" title="Instagram" class="instagram">Instagram</a> </li>
                                                                       
                        
                    </ul>
                <span class="icon icon-rocket"> </span> <span class="subcount"></span> </div>
            </li>

        </ul>

	</nav>
</header>



<section id="main">
  <h1 itemprop="name" >机器学习第一战——阿里天池移动推荐算法比赛经验总结攻略</h1>
  

<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Wed Jul 1, 2015 </h4>
          
        </section>
        
        <ul id="tags">
          
            <li> <a href="http://nanshu.wang/tags/%E9%98%BF%E9%87%8C">阿里</a> </li>
          
            <li> <a href="http://nanshu.wang/tags/%E6%AF%94%E8%B5%9B">比赛</a> </li>
          
            <li> <a href="http://nanshu.wang/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0">机器学习</a> </li>
          
            <li> <a href="http://nanshu.wang/tags/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98">数据挖掘</a> </li>
          
        </ul>
    </div>

</aside>

<meta itemprop="wordCount" content="140">
<meta itemprop="datePublished" content="2015-07-01">
<meta itemprop="url" content="http://nanshu.wang/post/2015-07-01">


  <div>
        <article itemprop="articleBody" id="content">
           

<p>历时98天的阿里移动推荐算法终于结束了，有种终于下了贼船的感觉。总的来说，整个比赛的体验并不好：时间太长，资源不够，打酱油的队友/男票，运气成分大，学到的干货少。阿里还有两场的比赛都不想参加了，觉得没必要把宝贵的研二时间都撘进去。虽然学到的干货不多，但这毕竟是在Data Science道路上进军的第一场实战，还是有必要好好总结一下。</p>

<h1 id="比赛统计:e22b26d8c6b3a4529619561860cf7538">比赛统计</h1>

<p>初赛名次：21
复赛名次：22
Python代码行数：2320
SQL代码行数：6656
天池平台数据表数：1006
线下结果数：490</p>

<h1 id="初识比赛:e22b26d8c6b3a4529619561860cf7538">初识比赛</h1>

<p>虽然比赛的名字叫做移动推荐算法，但本质上也是一个机器学习的问题。比赛给出了一个月（2014.11.18~2014.12.18）的用户对商品操作的行为数据，需要预测12.19号这天的购买行为，评分采用经典的F1值计算。行为数据中包括了时间、地点、用户、商品、行为类型、商品类别六个要素，特征提取的思路就是围绕这六个要素进行。题目还给出了一个商品子集，只需要提交对商品子集购买行为的预测结果。</p>

<p>大致看了去年前十选手的比赛总结，比赛流程大致分为4个模块：</p>

<ol>
<li>特征提取</li>
<li>训练集构造</li>
<li>模型学习调参</li>
<li>模型融合</li>
</ol>

<p>这4个模块并不是相互独立的，比如特征提取和训练集构造通常是一起完成，构造训练集也会用到简单模型学习来平衡正负样本数。</p>

<p>比赛分为两个赛季：
1. 初赛3.20-4.25，仅提供1万用户数据，采用本地调试提交。
2. 复赛4.30-7.1，有500万用户数据，使用阿里天池平台提交。</p>

<p>初赛和复赛是需要区别对待的：</p>

<ol>
<li>工具：初赛本地调试，学习模型和特征提取并不拘泥，可以用任意熟悉的工具。然而复赛需要使用天池平台，工具受限制。</li>
<li>模型or规则？：初赛数据量很小，很可能模型效果并不好，事实证明，规则实际上是简单粗暴效果佳的。复赛则不可能寄希望于规则，老老实实搞模型吧。</li>
<li>时间分配：初赛只用进前500名即可，不用投入太多的精力。到复赛前期越快熟悉环境越好，尽量前期多做，比赛资源并不充足，后期资源会非常有限，速度很慢。</li>
</ol>

<h1 id="初赛:e22b26d8c6b3a4529619561860cf7538">初赛</h1>

<p>初赛的环境使用了mySQL+Python，选择Python的原因是数据挖掘的包很齐全也容易上手：numpy、scipy、pandas，还有机器学习包scikit-learn，对付比赛足够用了。</p>

<h2 id="特征提取:e22b26d8c6b3a4529619561860cf7538">特征提取</h2>

<p>根据行为数据的各个字段，很容易可以将特征分为以下几类：</p>

<ol>
<li>用户-商品UI特征</li>
<li>用户特征</li>
<li>商品特征</li>
<li>类别特征</li>
<li>地理位置特征</li>
</ol>

<p>特征类别主要是计数和4行为转化率，比如用户1行为计数，4行为计数/1行为计数等等。</p>

<p>第一赛季并没有想到时间特征，只是根据时间划分训练集，第二赛季才发现时间特征非常重要。</p>

<p>为了便于特征提取，我用两种方法存放数据，一种是存入SQL表中：</p>

<blockquote>
<p>建立表logUser，user_id为主键,
字段名：
user_id,item_start,item_end</p>

<p>建立表logItem,item_idx为主键，
字段名：
item_idx,item_id,bhv_start,bhv_end</p>

<p>建立表logBhv,bhv_idx为主键，
字段名：
bhv_idx, behavior_type,user_geohash,item_category,time</p>
</blockquote>

<p>这样存放可以方便地提取UI特征，但事实证明这种方法实际上很慢，因为需要大量的SQL查询操作，不如用SQL的group by操作。幸而第一赛季数据量并不大，提取训练集并不是瓶颈。</p>

<p>第二种方法是将数据按天分开，便于提取user、item、geo、category的全局特征，这部分特征我全部使用了awk脚本提取。</p>

<h2 id="构造训练集:e22b26d8c6b3a4529619561860cf7538">构造训练集</h2>

<p>线下训练集使用12.18号购买行为标注样本，严格使用18号之前的数据提取特征（包括全局特征），样本为18号之前n天有交互行为的UI对。
线上预测集则使用19号之前n天所有的交互行为的UI对。</p>

<p>由于正例负例不平衡，需要对训练集进行抽样，抽样比例是在1:5到1:20这个区间里找最优结果。</p>

<h2 id="模型训练:e22b26d8c6b3a4529619561860cf7538">模型训练</h2>

<p>主要使用了Adaboost，Random forrest，Logistic Regression三种模型，直接调用Scikit-lSearn提供的模型训练。其中树型模型的测试结果最好。</p>

<p>然而第一赛季受到数据量的限制，实际上规则比模型好用多了，比如购物车+时间规则：前一天晚上8点后加入购入车的UI，就可以做到比单个模型结果好很多。</p>

<h2 id="模型融合:e22b26d8c6b3a4529619561860cf7538">模型融合</h2>

<p>第一赛季比赛前期一直死磕模型，成绩一直提不上去，改成规则后才大呼坑爹。</p>

<p>初赛的最优成绩使用了规则+模型混合的方法，使用规则得到候选集后，再从候选集中去掉多个模型预测的top k负例交集。</p>

<h1 id="复赛:e22b26d8c6b3a4529619561860cf7538">复赛</h1>

<p>第二赛季要使用天池平台，第一赛季的代码都用不上，得全部推翻重写。天池平台的工具有SQL、Map Reduce、UDF，算法平台也提供了经典的机器学习模型。</p>

<p>SQL容易学习，但写起来复杂容易出错，没有可读性，不提供参数设置，复用比较麻烦。Map Reduce和UDF学习成本高，可以实现复杂逻辑，但天池对这两个工具的限制很多，文档对用户非常不友好。</p>

<p>大部分特征、训练集和模型基本需求如计算f1等等都是通过SQL实现，少部分特征和其他复杂功能使用了UDF和Map Reduce。比较有用的是Map Reduce实现了特征information gain的计算，用来进行特征筛选，这要感谢队友/男票<a href="http://www.xgezhang.com">xge</a>。</p>

<h2 id="特征提取-1:e22b26d8c6b3a4529619561860cf7538">特征提取</h2>

<p>整个复赛的特征工程一共进行了10次更改，更改大多是增加新特征，从最初的22维增加到最后的380维。特征构建还是一赛季的思路，不过根据一赛季的结果，筛选掉了一部分无用特征。除了简单计数和4行为转化特征，在第一赛季基础上增加的特征有：</p>

<ol>
<li>时间特征

<ul>
<li>UI行为距离标注日的小时数</li>
<li>用时间衰减来计算加权后的行为计数</li>
<li>多次行为操作之间的时间间隔(Map Reduce实现)</li>
</ul></li>
<li>不同时间粒度的UI特征

<ul>
<li>按照标注日前1天，3天，7天，30天为粒度提取</li>
<li>按照标注日前4小时，8小时，16小时为粒度提取</li>
</ul></li>
<li>增加地理特征

<ul>
<li>用户商品的距离</li>
<li>用户地理用最后操作位置填充</li>
<li>商品地理用购买该商品的用户位置填充</li>
</ul></li>
<li>计数特征去重

<ul>
<li>商品特征计数对用户去重</li>
<li>类别特征计数对商品去重</li>
</ul></li>
<li>增加交叉特征

<ul>
<li>用户&amp;UI特征交叉</li>
<li>商品&amp;UI特征交叉</li>
<li>类别&amp;UI特征交叉</li>
<li>用户&amp;商品特征交叉</li>
</ul></li>
</ol>

<p>特征增加对分数提升是最显著的，在特征选择中也需要注意：</p>

<ol>
<li>不要盲目添加大量特征，最好一部分一部分添加，这样会对添加的特征效果有个大体的认识。</li>
<li>添加的特征要能从现实逻辑上解释得通，最好是直观上影响购买行为的特征。</li>
<li>特征筛选或许有用，但最好添加特征时就尽量加入有用的特征，不要妄图从一大堆特征中再筛选。</li>
</ol>

<h2 id="训练集构造:e22b26d8c6b3a4529619561860cf7538">训练集构造</h2>

<p>构造训练集前对数据进行了一个初步的统计，第二天的购买行为中仅有32%的UI是有过交互的，剩下64%的购买行为都是当天的偶发购买。前1天有过交互的占16%，前2天21%，前2天23%，前4天25%。也就是说，有一半的正样本是前1天的，因此<strong>仅仅使用前1天的交互UI构造训练集</strong>。</p>

<p>考虑到仅仅需要对商品子集进行预测，为了使训练集和预测集保持一致，又可以减少训练集的规模，所以<strong>只使用了商品子集内的商品构造训练集</strong>。</p>

<p>在比赛前期，这样构造训练集是有效的，缩短了模型训练时间，加快了特征迭代的工作。但是当特征增加不能再提升分数时，应该想到，这样构造训练集存在很大的问题，丢掉了很多正例样本。和其他队伍交流来看，这实际上是比赛后期的一个瓶颈，限制了特征的发挥。</p>

<p>正确的做法是：在特征工程比较完善之后，最好是比赛中期，使用不止1天的交互和商品全集构造训练集，采用简单模型过滤掉大量负样本。这点我到比赛后期才开始改，平台资源已经不够了，所以并没有做好，也是比赛的一大遗憾。</p>

<p>可以通过不同的标注日来得到不同的训练集，注意要预留出相同规模的验证集的测试集，到模型融合时会有用。</p>

<h2 id="模型学习-调参:e22b26d8c6b3a4529619561860cf7538">模型学习+调参</h2>

<ol>
<li>逻辑回归</li>
</ol>

<p>逻辑回归（Logistic Regression）训练速度预测速度很快，预测效果较差，可以用来进行负样本筛选，模型融合也有用。</p>

<ol>
<li>随机森林</li>
</ol>

<p>随机森林学习速度一般，预测速度很慢，主要用于模型融合。</p>

<ol>
<li>GBDT二分类</li>
</ol>

<p>GBDT训练速度慢，预测速度一般，单模型的效果最优。唯一的调参经验是：树越多越好，但速度也越慢。并且特征不一样，最优的参数也不一样，调参时注意每次最好只改变一个参数值，否则不容易看出参数的影响。不要使用枚举参数的办法调参，太浪费时间。</p>

<h2 id="模型融合-1:e22b26d8c6b3a4529619561860cf7538">模型融合</h2>

<p>总结一下道听途说模型融合的方法：
1. 取不同模型top k并集
2. 取不同模型top k交集
3. 直接将预测概率相加
4. 将预测概率作为特征用lr训练
5. 将预测概率作为特征加入验证集，再讲验证集当做训练集训练。</p>

<p>对我来说以上5种方法都是然并卵，不论使用哪种融合方式，总没有单模型的结果好。具体的原因还没有找到，或许是因为没有对训练集进行抽样，GBDT模型对正负样本比例并不敏感，所以我直接用了所有的负样本，也算是这次比赛的第二大遗憾吧。</p>

<h1 id="其他收获:e22b26d8c6b3a4529619561860cf7538">其他收获</h1>

<p>与其说是收获，不如说是一些犯过的错误，总结出来自勉：</p>

<ol>
<li>不要过早优化
主要是模型调参和模型融合，这两部分应当留到比赛中后期来做，过早优化耽误时间也没有意义。</li>
<li>不要短视
比赛每天都在更新名次，但不要只关注短期的分数，更要为长期做打算。比如虽然调参、获得更多的训练集会提升暂时的分数，但是也失去了快速迭代特征的机会。要时刻记住这是一场长时间的比赛，终点才是胜利，中间领跑并不说明问题。</li>
<li>合理安排时间精力
初赛不需要投入全部精力，复赛前期尽量多做，否则后期没有资源。</li>
<li>不要妄下结论
对于不确定的猜想，一定要用数据验证，比如训练集用商品全集还是子集的区别，是否需要抽样等等。尽量多试多做，要去尝试各种可能性。</li>
<li>不要懒，不要懒，不要懒
重要的事情说三遍。有时会觉得麻烦，于是采用了写起来简单但效率低的方法。有时明明应该改成另一种方法，又觉得不改也没影响就算了吧。有时觉得今天太晚了就不做了，马虎总是不检查提交结果，于是又浪费了很多次机会。</li>
</ol>

        </article>
  </div>
</section>

<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'nanshuwang';
    var disqus_identifier = 'http:\/\/nanshu.wang\/post\/2015-07-01';
    var disqus_title = '机器学习第一战——阿里天池移动推荐算法比赛经验总结攻略';
    var disqus_url = 'http:\/\/nanshu.wang\/post\/2015-07-01';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2015 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Nanshu Wang.</span></span>
        Powered by <a href="http://hugo.spf13.com">Hugo</a>.
        Theme by <a href="http://spf13.com">Steve Francia</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>


<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</body>